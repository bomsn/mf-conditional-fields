/* (c) 2024 MF Conditional Fields - https://github.com/bomsn/mf-conditional-fields */
"use strict";const mfConditionalFields=(d,e={})=>{switch(typeof d){case"string":d=document.querySelectorAll(d);break;case"object":if(!1===Array.isArray(d)&&Object.prototype.hasOwnProperty.call(d,"0")){d=Object.fromEntries(Object.entries(d).filter(([e,t])=>!isNaN(e)&&void 0!==t.elements));d=Object.values(d)}else d=Array.isArray(d)?d:[d]}let a=e.rules||"inline",t=e.dynamic||!1,s=e.unsetHidden||!1,u=e.disableHidden||!1,i=e.debug||!1,f=e.depth||3,c=[],m=[],n=[],h={initField:(l,o)=>{var r=l.getAttribute("data-conditional-rules");if(0<r.length){let e="container"in(r=JSON.parse(r))?r.container:"",t="action"in r?r.action:"show",i="logic"in r?r.logic:"or",n="rules"in r?r.rules:[];if(0<(n="object"==typeof n&&void 0===n.length?[n]:n).length){for(let t=0;n.length>t;t++)if("group"in n[t])for(let e=0;n[t].group.length>e;e++)"name"in n[t].group[e]&&!m[o].includes(n[t].group[e].name)&&m[o].push(n[t].group[e].name);else"name"in n[t]&&!m[o].includes(n[t].name)&&m[o].push(n[t].name);l.removeAttribute("data-conditional-rules");l.mfConditionalContainerSelector=e;l.mfConditionalAction=t;l.mfConditionalLogic=i;l.mfConditionalRules=n;l.mfConditionalFormIndex=o;h.updateField(l)}}},updateField:(e,t=1)=>{let n=e.mfConditionalFormIndex,i=e.mfConditionalAction,l=e.mfConditionalLogic,o=e.mfConditionalRules,r=!1;if(0<o.length)for(let i=0;o.length>i;i++){let t=!1;if("group"in o[i]){var a,d=o[i].relation||"and";for(let e=0;o[i].group.length>e;e++){if(0==(a=h.evaluateRule(o[i].group[e],n))&&"and"==d){t=!1;break}if(a&&"or"==d){t=!0;break}t=a}}else t=h.evaluateRule(o[i],n);if(!1===t&&"and"==l){r=!1;break}if(t&&"or"==l){r=!0;break}r=t}if(r)h.toggleField(e,i,t);else{i="hide"==i?"show":"show"==i?"hide":"disable"==i?"enable":"enable"==i?"disable":"none";h.toggleField(e,i,t)}},toggleField:(e,t,i)=>{let n=e.mfConditionalFormIndex,l=e.name,o=e.mfConditionalContainerSelector,r=null;if(i<f&&m[n].includes(l)){var a=h.getDependantField(l,n);if(0<a.length)for(let e=0;a.length>e;e++){var d=a[e].mfConditionalAction;"hide"==t&&"disable"!==d&&"enable"!==d?h.toggleField(a[e],"hide",++i):h.updateField(a[e],++i)}}if("hide"==t){""==o?e.setAttribute("hidden",!0):(r=e.closest(""+o))&&r.setAttribute("hidden",!0);u&&e.setAttribute("disabled","disabled");s&&("checkbox"==e.type||"radio"==e.type?e.checked=!1:e.value="")}else if("disable"==t)e.setAttribute("disabled","disabled");else if("enable"==t)e.hasAttribute("disabled")&&e.removeAttribute("disabled");else if("show"==t){""==o?e.removeAttribute("hidden"):(r=e.closest(""+o))&&r.removeAttribute("hidden");u&&e.removeAttribute("disabled")}},getDependantField:(i,t)=>{let n=[];if(void 0!==c[t])for(let e=0;c[t].length>e;e++)if("mfConditionalRules"in c[t][e]){var l=c[t][e].mfConditionalRules.some(t=>{if("group"in t){for(let e=0;t.group.length>e;e++)if(t.group[e].name===i)return!0;return!1}return t.name===i});void 0!==l&&!1!==l&&n.push(c[t][e])}return n},evaluateRule:(l,o)=>{var r=l.name,a=l.operator,l=l.value;if(m[o].includes(r)){let t=d[o].querySelectorAll('[name="'+r+'"]'),e,i,n;if(0<t.length){"radio"!==(e=t[0].type)&&"checkbox"!==e&&(t=t[0]);if("radio"==e||"checkbox"==e){i=[];for(let e=0;e<t.length;e++){t[e].checked&&i.push(t[e].value);e===t.length-1&&(i=i.join("|"))}}else if("select-multiple"==e){i=[];for(let e=0;e<t.options.length;e++)t.options[e].selected&&i.push(t.options[e].value);i=i.join("|")}else i=t.value;n=h.compareValues(a,i,l)}return n}return!1},compareValues:(e,t,i)=>{t=t?t.toString().toLowerCase():"",i=i?i.toString().toLowerCase():"";switch(e){case"is":return i===t;case"isnot":return i!==t;case"greaterthan":return!isNaN(t)&&!isNaN(i)&&Number(t)>Number(i);case"lessthan":return!isNaN(t)&&!isNaN(i)&&Number(t)<Number(i);case"contains":return t.includes(i);case"doesnotcontain":return!t.includes(i);case"beginswith":return t.startsWith(i);case"doesnotbeginwith":return!t.startsWith(i);case"endswith":return t.endsWith(i);case"doesnotendwith":return!t.endsWith(i);case"isempty":return""===t;case"isnotempty":return""!==t}return!1},updateForm:async(o,e="add")=>{if(void 0===d[o])return!1;if("add"==e)try{let i;i=await new Promise((e,t)=>{let l=[];if("inline"==a)l=d[o].querySelectorAll("[data-conditional-rules]");else{for(let n=0;a.length>n;n++)if("field"in a[n]){let i=d[o].elements[a[n].field];i=i instanceof RadioNodeList?Array.from(i):[i];for(let t=0;i.length>t;t++)if(void 0!==i[t]){let e=i[t];e.setAttribute("data-conditional-rules",JSON.stringify(a[n]));l.push(e)}delete a[n].field}a=null}if(0<l.length){c[o]=c[o].concat(Array.prototype.slice.call(l));e(l)}else t("No conditional fields found on step 1")});await new Promise((t,e)=>{if(0<i.length)for(let e=0;i.length>e;e++){h.initField(i[e],o);e===i.length-1&&t()}else e("No conditional fields to initialize on step 2")});if(0<m.length)for(let e=0;m[o].length>e;e++)if(!n[o].includes(m[o][e])){let t=d[o].querySelectorAll('[name="'+m[o][e]+'"]');if(0===t.length&&0<(t=d[o].querySelectorAll('[type="checkbox"][name="'+m[o][e]+'[]"]')).length){var r=m[o][e];m[o][e]=m[o][e]+"[]";let l=h.getDependantField(r,o);if(0<l.length)for(let n=0;l.length>n;n++)if(0<l[n].mfConditionalRules.length){let i=!1;for(let t=0;l[n].mfConditionalRules.length>t;t++)if("group"in l[n].mfConditionalRules[t]){for(let e=0;l[n].mfConditionalRules[t].group.length>e;e++)if(l[n].mfConditionalRules[t].group[e].name==r){l[n].mfConditionalRules[t].group[e].name=r+"[]";i=!0}}else if(l[n].mfConditionalRules[t].name==r){l[n].mfConditionalRules[t].name=r+"[]";i=!0}i&&h.updateField(l[n])}}if(0<t.length){for(let e=0;t.length>e;e++){t[e].mfConditionalFormIndex=o;t[e].addEventListener("change",h.fieldListener,!1)}n[o].push(m[o][e])}t=null}return!0}catch(t){if(i){let e="formIndex: "+o;void 0!==d[o].getAttribute("id")&&(e="formId: "+d[o].getAttribute("id"));console.info(e+" => "+t)}return!1}else if("remove"==e){c[o]=c[o].filter(e=>void 0!==d[o].elements[""+e.name]);m[o]=m[o].filter(e=>void 0!==d[o].elements[""+e]);n[o]=n[o].filter(e=>void 0!==d[o].elements[""+e]);return!0}return!1},fieldListener:e=>{var t=h.getDependantField(e.target.name,e.target.mfConditionalFormIndex);if(0<t.length)for(let e=0;t.length>e;e++)h.updateField(t[e])},formListener:e=>{var t=e.target.mfConditionalFormIndex,e=e.detail.action;h.updateForm(t,e)}};if("block"==a){e=document.getElementById("rules-mf-conditional-fields");a=JSON.parse(e.innerHTML)}if("inline"!==a&&"object"!=typeof a)return i&&console.warn("The supplied rules or rule type is not valid."),!1;if(!(0<d.length))return i&&console.warn("The supplied conditional form was not found"),!1;for(let e=0;d.length>e;e++){c.push([]);m.push([]);n.push([]);d[e].mfConditionalFormIndex=e;h.updateForm(e)}if(t)for(let e=0;d.length>e;e++)d[e].addEventListener("mfConditionalFormUpdated",h.formListener,!1)};"undefined"!=typeof window&&(window.mfConditionalFields=mfConditionalFields);